<!doctype html>
<html lang="zh-CN">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<title>图片格式转换器</title>
	<style>
		:root{--bg:#f4f6f8;--card:#ffffff;--primary:#0066cc;--muted:#6b7280;--accent:#0ea5a4}
		*{box-sizing:border-box}
		html,body{height:100%}
		body{font-family:Inter, ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; background:linear-gradient(180deg,var(--bg),#eef2f6); color:#0f172a; margin:0}
		.container{max-width:980px;margin:36px auto;padding:20px}
		header{display:flex;align-items:center;gap:14px;margin-bottom:18px}
		.logo{width:52px;height:52px;border-radius:10px;background:linear-gradient(135deg,var(--primary),var(--accent));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:18px}
		.title{line-height:1}
		.title h1{margin:0;font-size:20px}
		.title p{margin:2px 0 0;color:var(--muted);font-size:13px}

		.card{background:var(--card);border-radius:12px;padding:18px;box-shadow:0 10px 30px rgba(16,24,40,0.06)}
		.panel{display:flex;gap:18px;flex-wrap:wrap;align-items:flex-start}

		.uploader{flex:1;min-width:300px;border:2px dashed #e6eef6;border-radius:10px;padding:18px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;transition:background .18s,border-color .18s}
		.uploader.drag{background:linear-gradient(180deg,#f8feff,#ffffff);border-color:var(--accent)}
		.uploader .hint{color:var(--muted);font-size:14px;text-align:center}
		.uploader input[type=file]{display:none}

		.meta{width:240px;min-width:220px}
		.row{display:flex;gap:8px;align-items:center;margin:10px 0}
		label{font-size:13px;color:#0f172a;min-width:74px}
		select,input[type=range]{width:100%;padding:8px;border-radius:8px;border:1px solid #e6eef6;background:#fbfdff}

		#preview{width:100%;max-height:360px;object-fit:contain;border-radius:8px;background:#f8fafc;padding:8px;border:1px solid #f1f5f9}

		.controls{display:flex;gap:10px;align-items:center;margin-top:6px}
		.btn{background:var(--primary);color:#fff;border:none;padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer;box-shadow:0 6px 18px rgba(3,102,214,.12)}
		.btn.ghost{background:transparent;color:var(--primary);box-shadow:none;border:1px solid rgba(3,102,214,.08)}
		.btn:disabled{opacity:.5;cursor:not-allowed}

		.note{font-size:13px;color:var(--muted)}
		.file-info{font-size:13px;color:var(--muted);margin-top:8px}

		footer{margin-top:14px;color:var(--muted);font-size:13px;text-align:center}

		@media(max-width:720px){.panel{flex-direction:column}.meta{width:100%}}
	</style>
</head>
<body>
	<div class="container">
		<header>
			<div class="logo">IC</div>
			<div class="title">
				<h1>图片格式转换器</h1>
				<p>本地转换 · 保持隐私 · 快速下载</p>
			</div>
		</header>

		<div class="card">
			<div class="panel">
				<div class="uploader" id="uploader">
					<input id="file" type="file" accept="image/*">
					<svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 3v10" stroke="#0ea5a4" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M8 7l4-4 4 4" stroke="#0ea5a4" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
					<div class="hint">拖拽图片到此处或点击选择</div>
					<div class="file-info" id="fileInfo"></div>
					<img id="preview" alt="预览（上传后显示）">
				</div>

				<aside class="meta">
					<div class="row"><label>目标格式</label><select id="format"><option value="image/png">PNG</option><option value="image/jpeg">JPEG</option><option value="image/webp">WEBP</option></select></div>
					<div class="row"><label>质量</label><input id="quality" type="range" min="0.1" max="1" step="0.05" value="0.92"><span id="qval" class="note">0.92</span></div>
					<div class="controls">
						<button id="convert" class="btn" disabled>转换并下载</button>
						<button id="resetBtn" class="btn ghost">重置</button>
					</div>
					<div id="status" class="note" style="margin-top:10px"></div>
					<a id="downloadLink" style="display:none;margin-top:8px;word-break:break-all" download></a>
				</aside>
			</div>
		</div>

		<footer>本工具在浏览器端完成转换，不会上传图片到服务器。</footer>
		<canvas id="canvas" style="display:none"></canvas>
	</div>

	<script>
		const fileEl = document.getElementById('file');
		const uploader = document.getElementById('uploader');
		const formatEl = document.getElementById('format');
		const qualityEl = document.getElementById('quality');
		const qval = document.getElementById('qval');
		const convertBtn = document.getElementById('convert');
		const resetBtn = document.getElementById('resetBtn');
		const downloadLink = document.getElementById('downloadLink');
		const status = document.getElementById('status');
		const preview = document.getElementById('preview');
		const fileInfo = document.getElementById('fileInfo');
		const canvas = document.getElementById('canvas');

		let currentFile = null;

		fileEl.addEventListener('change', e=>{ handleFileSelection(e.target.files && e.target.files[0]); });

		// drag & drop
		['dragenter','dragover'].forEach(ev=>{
			uploader.addEventListener(ev, e=>{ e.preventDefault(); uploader.classList.add('drag'); });
		});
		['dragleave','drop','dragend'].forEach(ev=>{
			uploader.addEventListener(ev, e=>{ e.preventDefault(); uploader.classList.remove('drag'); });
		});
		uploader.addEventListener('drop', e=>{
			const f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
			handleFileSelection(f);
		});

		function handleFileSelection(f){
			if(!f) return reset();
			if(!f.type.startsWith('image/')){ alert('请选择图片文件'); reset(); return; }
			currentFile = f;
			fileInfo.textContent = `${f.name} · ${(f.size/1024).toFixed(1)} KB`;
			const reader = new FileReader();
			reader.onload = ()=>{ preview.src = reader.result; preview.style.display='block'; convertBtn.disabled = false; status.textContent = ''; }
			reader.readAsDataURL(f);
		}

		qualityEl.addEventListener('input', ()=>{ qval.textContent = parseFloat(qualityEl.value).toFixed(2); });

		convertBtn.addEventListener('click', async ()=>{
			if(!currentFile) return;
			convertBtn.disabled = true;
			status.textContent = '处理中…';
			try{
				const img = await loadImageFromFile(currentFile);
				// limit large canvas to avoid memory spikes (max 4k)
				const maxDim = 4096;
				let w = img.naturalWidth || img.width;
				let h = img.naturalHeight || img.height;
				if(Math.max(w,h) > maxDim){
					const ratio = maxDim / Math.max(w,h);
					w = Math.round(w*ratio); h = Math.round(h*ratio);
				}
				canvas.width = w; canvas.height = h;
				const ctx = canvas.getContext('2d');
				ctx.clearRect(0,0,canvas.width,canvas.height);
				ctx.drawImage(img,0,0,canvas.width,canvas.height);

				const mime = formatEl.value;
				const quality = (mime === 'image/png') ? undefined : parseFloat(qualityEl.value);

				canvas.toBlob(blob=>{
					if(!blob){ status.textContent='转换失败'; convertBtn.disabled=false; return; }
					const filename = makeOutputName(currentFile.name, mime);
					const url = URL.createObjectURL(blob);
					downloadLink.href = url;
					downloadLink.download = filename;
					downloadLink.style.display = 'block';
					downloadLink.textContent = '点击下载 ' + filename;
					status.textContent = `已准备好 — ${ (blob.size/1024).toFixed(1) } KB`;
					convertBtn.disabled = false;
				}, mime, quality);

			}catch(err){
				console.error(err);
				status.textContent = '处理出错：' + (err.message||err);
				convertBtn.disabled = false;
			}
		});

		resetBtn.addEventListener('click', ()=> reset());

		function reset(){ currentFile = null; preview.src=''; convertBtn.disabled = true; downloadLink.style.display='none'; status.textContent=''; }

		function loadImageFromFile(file){
			return new Promise((resolve,reject)=>{
				const url = URL.createObjectURL(file);
				const img = new Image();
				img.onload = ()=>{ URL.revokeObjectURL(url); resolve(img); };
				img.onerror = e=>{ URL.revokeObjectURL(url); reject(new Error('无法加载图片')); };
				img.src = url;
			});
		}

		function makeOutputName(orig, mime){
			const ext = (mime==='image/png')?'.png':(mime==='image/jpeg')?'.jpg':(mime==='image/webp')?'.webp':'';
			const base = orig.replace(/\.[^.]+$/, '');
			return base + ext;
		}
	</script>
</body>
</html>
